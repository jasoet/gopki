# OpenSSL Signing Compatibility Testing Framework

This document provides comprehensive documentation for digital signature compatibility testing between GoPKI and OpenSSL, ensuring perfect interoperability for all signing operations and formats.

## Overview

The OpenSSL signing compatibility framework validates that digital signatures, PKCS#7/CMS formats, and cryptographic operations generated by GoPKI are fully compatible with OpenSSL and vice versa. This ensures that GoPKI can be used as a drop-in replacement for OpenSSL signing operations in Go applications.

## Test Coverage

### Supported Algorithms

**RSA Signatures**
- RSA-2048 (minimum secure size for signatures)
- RSA-3072 (enhanced security)
- RSA-4096 (maximum security for high-value signatures)

**ECDSA Signatures**
- P-256 (prime256v1) - Most common curve for signatures
- P-384 (secp384r1) - Enhanced security for enterprise use
- P-521 (secp521r1) - Maximum security for critical signatures

**Ed25519 Signatures**
- Ed25519 (modern curve) - High performance, excellent security

### Test Categories

#### 1. **Raw Signature Compatibility**
- GoPKI generates signatures → OpenSSL verifies
- OpenSSL generates signatures → GoPKI verifies
- Cross-platform signature validation for all algorithms
- Hash algorithm consistency (SHA256, SHA384, SHA512)

#### 2. **PKCS#7/CMS Format Compatibility**
- PKCS#7 attached signature format validation
- PKCS#7 detached signature format validation
- Certificate inclusion in signature containers
- Cross-tool PKCS#7 format parsing and verification

#### 3. **Detached Signature Workflows**
- Detached vs attached signature handling
- Separate data and signature file workflows
- Certificate chain preservation in detached signatures
- Multi-file signature verification scenarios

#### 4. **Certificate Chain Integration**
- Certificate chain inclusion in signatures
- Multi-level certificate hierarchy validation
- CA certificate chain verification
- Trust anchor and intermediate certificate handling

#### 5. **Advanced Signature Features**
- Signature metadata extraction and validation
- Multiple hash algorithm support
- Signature format detection and validation
- Cross-algorithm signature verification

## Directory Structure

```
compatibility/signing/
├── signing_test.go          # Main compatibility tests with build tags
├── doc.md                  # This comprehensive documentation
└── README.md              # Quick reference guide
```

## Test Implementation

### Build Tags

All signing compatibility tests use build tags for conditional execution:

```go
//go:build compatibility

package signing
```

**Execution:**
```bash
# Run signing compatibility tests only
go test -tags=compatibility ./compatibility/signing -v

# Run all compatibility tests
go test -tags=compatibility ./compatibility/... -v

# Using Taskfile
task test:compatibility:signing
```

### Test Structure

**Algorithm-Specific Testing:**
```go
func TestSigningCompatibility(t *testing.T) {
    t.Run("RSA", func(t *testing.T) {
        testRSASigningCompatibility(t)
    })
    t.Run("ECDSA", func(t *testing.T) {
        testECDSASigningCompatibility(t)
    })
    t.Run("Ed25519", func(t *testing.T) {
        testEd25519SigningCompatibility(t)
    })
}
```

**Bidirectional Testing Pattern:**
For each algorithm, comprehensive bidirectional testing ensures full compatibility:
- `GoPKI_Sign_OpenSSL_Verify` - GoPKI creates signatures, OpenSSL validates
- `OpenSSL_Sign_GoPKI_Verify` - OpenSSL creates signatures, GoPKI validates
- `PKCS7_Format_Compatibility` - PKCS#7 format cross-validation
- `Detached_Signature_Compatibility` - Detached signature workflows

## OpenSSL Helper Functions

The framework includes specialized helper functions for signing operations:

### Core Signing Functions

**`CreatePKCS7SignatureWithOpenSSL()`**
- Creates PKCS#7 signatures using OpenSSL `cms` command
- Supports both attached and detached signature modes
- Handles certificate inclusion automatically

**`VerifyPKCS7SignatureWithOpenSSL()`**
- Verifies PKCS#7 signatures using OpenSSL
- Validates signature format and cryptographic correctness
- Supports certificate chain verification

**`CreateRawSignatureWithOpenSSL()`**
- Creates raw signatures using OpenSSL `dgst` command
- Algorithm-specific signature generation (RSA, ECDSA, Ed25519)
- Hash algorithm selection and validation

**`VerifyRawSignatureWithOpenSSL()`**
- Verifies raw signatures using OpenSSL
- Cross-algorithm signature verification
- Hash algorithm consistency validation

### Advanced Functions

**`VerifyPKCS7SignatureWithCertificateChainWithOpenSSL()`**
- Verifies signatures with complete certificate chain validation
- CA certificate trust anchor verification
- Multi-level certificate hierarchy support

**`ExtractSignatureInfoWithOpenSSL()`**
- Extracts signature metadata using OpenSSL
- Parses signature algorithm, hash algorithm, certificates
- Validates signature container structure

**`ValidateSignatureFormatWithOpenSSL()`**
- Validates signature format compliance
- ASN.1 structure verification
- PKCS#7/CMS container validation

## Validation Scope

### Cryptographic Validation

**Signature Verification:**
- ✅ Cross-platform signature validation (GoPKI ↔ OpenSSL)
- ✅ Algorithm-specific parameter validation
- ✅ Hash algorithm consistency verification
- ✅ Signature format standards compliance

**Certificate Integration:**
- ✅ Certificate inclusion in signature containers
- ✅ Certificate chain preservation and validation
- ✅ CA certificate trust anchor verification
- ✅ Certificate validity period checks

### Format Standards Compliance

**PKCS#7/CMS Compliance:**
- ✅ RFC 5652 Cryptographic Message Syntax compliance
- ✅ ASN.1 structure validation
- ✅ Certificate and signature container format
- ✅ Detached vs attached signature handling

**Cross-Tool Interoperability:**
- ✅ Format parsing consistency between tools
- ✅ Metadata preservation across formats
- ✅ Certificate chain encoding compatibility
- ✅ Signature algorithm parameter consistency

## Practical Usage Examples

### Basic Signature Compatibility Test

```go
func testBasicSignatureCompatibility(t *testing.T) {
    // Generate key pair and certificate
    manager, _ := keypair.Generate[algo.KeySize, *algo.RSAKeyPair, *rsa.PrivateKey, *rsa.PublicKey](algo.KeySize2048)
    certificate, _ := cert.CreateSelfSignedCertificate(manager.KeyPair(), certRequest)

    // Sign with GoPKI
    signature, _ := signing.SignDocument(testData, manager.KeyPair(), certificate, opts)

    // Verify with OpenSSL
    privatePEM, publicPEM, _ := manager.ToPEM()
    err := helper.VerifyRawSignatureWithOpenSSL(testData, signature.Data, publicPEM, "RSA", "sha256")
    assert.NoError(t, err)
}
```

### PKCS#7 Format Compatibility Test

```go
func testPKCS7FormatCompatibility(t *testing.T) {
    // Create PKCS#7 signature with GoPKI
    opts := signing.DefaultSignOptions()
    opts.Format = signing.FormatPKCS7
    opts.IncludeCertificate = true

    signature, _ := signing.SignDocument(testData, manager.KeyPair(), certificate, opts)

    // Verify PKCS#7 format with OpenSSL
    err := helper.VerifyPKCS7SignatureWithOpenSSL(testData, signature.Data)
    assert.NoError(t, err)
}
```

## Performance Considerations

### Algorithm Performance

**RSA Signatures:**
- RSA-2048: ~10ms signing, ~1ms verification
- RSA-4096: ~50ms signing, ~2ms verification
- Larger keys provide more security but impact performance

**ECDSA Signatures:**
- P-256: ~2ms signing, ~3ms verification
- P-384: ~4ms signing, ~6ms verification
- P-521: ~8ms signing, ~12ms verification
- Best performance/security ratio for most applications

**Ed25519 Signatures:**
- ~0.5ms signing, ~1ms verification
- Excellent performance with high security
- Recommended for high-throughput applications

### Test Execution Performance

**Parallel Execution:**
- Tests run in parallel per algorithm
- Independent temporary directory per test
- Automatic cleanup of temporary files
- Optimized for CI/CD environments

**Resource Usage:**
- Temporary file creation and cleanup
- OpenSSL process spawning overhead
- Certificate generation can be CPU-intensive
- Memory usage scales with key size and test count

## Troubleshooting

### Common Issues

**OpenSSL Version Compatibility:**
```bash
# Check OpenSSL version
openssl version

# Verify CMS command availability
openssl cms -help
```

**Certificate Chain Issues:**
- Ensure certificate chain order is correct (leaf → intermediate → root)
- Verify certificate validity periods
- Check certificate key usage extensions

**Signature Format Problems:**
- Validate ASN.1 structure with `openssl asn1parse`
- Check PKCS#7 container with `openssl cms -print`
- Verify signature algorithm compatibility

### Debug Commands

**Signature Analysis:**
```bash
# Analyze PKCS#7 signature structure
openssl cms -in signature.p7s -inform DER -print -noout

# Extract certificates from signature
openssl cms -in signature.p7s -inform DER -print_certs -noout

# Verify signature manually
openssl cms -verify -in signature.p7s -inform DER -content data.bin -noverify
```

**Certificate Chain Analysis:**
```bash
# Display certificate chain
openssl x509 -in cert.pem -text -noout

# Verify certificate chain
openssl verify -CAfile ca.pem cert.pem

# Check certificate purpose
openssl x509 -in cert.pem -purpose -noout
```

## Integration with CI/CD

### GitHub Actions Example

```yaml
name: Signing Compatibility Tests
on: [push, pull_request]

jobs:
  signing-compatibility:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-go@v3
      with:
        go-version: '1.21'

    - name: Install OpenSSL
      run: |
        sudo apt-get update
        sudo apt-get install openssl
        openssl version

    - name: Run Signing Compatibility Tests
      run: |
        go test -tags=compatibility ./compatibility/signing -v

    - name: Run All Compatibility Tests
      run: |
        go test -tags=compatibility ./compatibility/... -v
```

### Docker Integration

```dockerfile
FROM golang:1.21-alpine
RUN apk add --no-cache openssl
WORKDIR /app
COPY . .
RUN go test -tags=compatibility ./compatibility/signing -v
```

## Security Considerations

### Validation Boundaries

**What the Tests Validate:**
- ✅ Cryptographic signature correctness
- ✅ Format standards compliance (RFC 5652)
- ✅ Cross-platform interoperability
- ✅ Certificate chain validation
- ✅ Algorithm parameter consistency

**What the Tests Do NOT Validate:**
- ❌ Side-channel attack resistance
- ❌ Timing attack protection
- ❌ Hardware security module integration
- ❌ Key entropy quality beyond basic validation
- ❌ Production certificate authority policies

### Test Key Material

**Security Notes:**
- All test keys and certificates are generated in temporary directories
- Private keys are automatically cleaned up after tests
- No real cryptographic material is exposed or reused
- Test keys should NEVER be used in production environments

**File Permissions:**
- Private keys created with 0600 permissions (owner read/write only)
- Temporary directories created with 0700 permissions
- Automatic cleanup prevents key material exposure

## Contributing

### Adding New Signature Tests

1. **Extend Test Coverage:**
   - Add new algorithm support in test functions
   - Include additional signature formats
   - Add edge case validation

2. **Helper Function Development:**
   - Add new OpenSSL command integrations
   - Extend format validation capabilities
   - Improve error handling and logging

3. **Documentation Updates:**
   - Update this documentation for new features
   - Add usage examples for new functionality
   - Update troubleshooting guides

### Code Quality Standards

**Testing Requirements:**
- Comprehensive bidirectional testing (GoPKI ↔ OpenSSL)
- Proper error handling and validation
- Extensive logging for debugging
- Temporary resource cleanup
- Build tag conditional execution

**Performance Optimization:**
- Parallel test execution where possible
- Efficient temporary file management
- Minimal OpenSSL process spawning
- Resource usage monitoring

This comprehensive signing compatibility framework ensures GoPKI maintains **100% compatibility** with OpenSSL for all digital signature operations, formats, and certificate integration scenarios.