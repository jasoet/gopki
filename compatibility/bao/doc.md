# GoPKI ↔ OpenBao Compatibility Testing - Detailed Documentation

This document provides comprehensive documentation for the GoPKI ↔ OpenBao compatibility test suite.

## Table of Contents

1. [Purpose](#purpose)
2. [Architecture](#architecture)
3. [Test Organization](#test-organization)
4. [Detailed Test Coverage](#detailed-test-coverage)
5. [Helper Functions](#helper-functions)
6. [Common Patterns](#common-patterns)
7. [Best Practices](#best-practices)

---

## Purpose

The compatibility test suite ensures that:

1. **Local GoPKI modules** (`keypair`, `cert`, `signing`, `encryption`, `pkcs12`, `jose`) work seamlessly with cryptographic materials from **OpenBao**
2. **OpenBao client** (bao package) correctly integrates with local GoPKI operations
3. **Bidirectional compatibility** exists for all supported operations

### What We're NOT Testing

- ❌ OpenSSL ↔ OpenBao compatibility (OpenBao handles this internally)
- ❌ OpenBao server internals (that's OpenBao's responsibility)
- ❌ Network protocols or TLS handshakes (only certificate/key operations)

### What We ARE Testing

- ✅ GoPKI local key generation → Import to OpenBao
- ✅ OpenBao key generation → Use with GoPKI modules
- ✅ OpenBao CA → Sign with GoPKI cert module
- ✅ GoPKI CSR → Sign with OpenBao
- ✅ OpenBao certificates → GoPKI signing/encryption
- ✅ Full workflows combining multiple modules

---

## Architecture

### Test Environment Setup

```
┌─────────────────────────────────────────────────┐
│  Test Process                                   │
│  ┌──────────────────────────────────────────┐   │
│  │  TestFunction                            │   │
│  │  ┌────────────────────────────────────┐  │   │
│  │  │ SetupBaoTest(t)                    │  │   │
│  │  │  • Start OpenBao container         │  │   │
│  │  │  • Enable PKI engine               │  │   │
│  │  │  • Create bao.Client               │  │   │
│  │  │  • Return TestEnvironment          │  │   │
│  │  └────────────────────────────────────┘  │   │
│  │                                           │   │
│  │  ┌────────────────────────────────────┐  │   │
│  │  │ Run compatibility checks           │  │   │
│  │  │  • GoPKI operations                │  │   │
│  │  │  • OpenBao operations              │  │   │
│  │  │  • Verify interoperability         │  │   │
│  │  └────────────────────────────────────┘  │   │
│  │                                           │   │
│  │  defer env.Cleanup()                     │   │
│  └──────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
                      ↕
        ┌─────────────────────────┐
        │  Docker Container       │
        │  ┌───────────────────┐  │
        │  │ OpenBao Server    │  │
        │  │ • Dev mode        │  │
        │  │ • PKI enabled     │  │
        │  │ • Port: random    │  │
        │  └───────────────────┘  │
        └─────────────────────────┘
```

### Test Lifecycle

1. **Setup Phase**
   - Docker pulls `openbao/openbao:2.4.3` image (if needed)
   - Testcontainer starts OpenBao in dev mode
   - Health check waits for ready state
   - PKI secrets engine is mounted at `/pki`
   - Bao client is configured and returned

2. **Execution Phase**
   - Tests perform GoPKI and OpenBao operations
   - Compatibility is verified at each step
   - Assertions validate correct behavior

3. **Cleanup Phase**
   - Container is terminated
   - Resources are freed
   - Logs are captured if test fails

---

## Test Organization

### File Structure

```
compatibility/bao/
├── helpers.go           # Test utilities and setup
├── keypair_test.go      # Keypair compatibility
├── cert_test.go         # Certificate operations
├── signing_test.go      # PKCS#7/CMS signing
├── encryption_test.go   # Encryption operations
├── pkcs12_test.go       # PKCS#12 bundles
├── jose_test.go         # JWK/JWS/JWT operations
├── workflow_test.go     # End-to-end scenarios
├── README.md            # Quick reference
└── doc.md               # This file
```

### Naming Conventions

#### Test Functions
```go
func TestModule_Bao_Compatibility(t *testing.T)
```
Example: `TestKeypair_Bao_Compatibility`, `TestCert_Bao_Compatibility`

#### Sub-Tests
```go
t.Run("Feature_Category", func(t *testing.T) {
    t.Run("Specific_Test_Case", testFunctionName)
})
```
Example: `t.Run("GoPKI_Generate_Bao_Import", testRSAKeyGoPKIToBao)`

#### Helper Functions
```go
func testSpecificScenario(t *testing.T)
func TestFeatureGroup(t *testing.T) // Entry point
```

---

## Detailed Test Coverage

### 1. Keypair Compatibility (`keypair_test.go`)

#### Purpose
Verify that keys generated by either system work with the other.

#### Test Matrix

| Key Type  | Size/Curve | GoPKI→Bao | Bao→GoPKI | Bao Issue Cert |
|-----------|------------|-----------|-----------|----------------|
| RSA       | 2048       | ✅        | ✅        | ✅             |
| RSA       | 3072       | ✅        | ✅        | ✅             |
| RSA       | 4096       | ✅        | ✅        | ✅             |
| ECDSA     | P-256      | ✅        | ✅        | ✅             |
| ECDSA     | P-384      | ✅        | ✅        | ✅             |
| ECDSA     | P-521      | ✅        | ✅        | ✅             |
| Ed25519   | 256        | ✅        | ✅        | ✅             |

#### Key Test Scenarios

**Scenario 1: GoPKI Generate → Bao Import**
```go
// Generate with GoPKI
keyPair, _ := algo.GenerateRSAKeyPair(2048)

// Import to Bao
keyClient, _ := client.ImportRSAKey(ctx, "my-key", keyPair, &bao.ImportKeyOptions{})

// Verify accessible
keyInfo, _ := keyClient.GetKeyInfo(ctx)
```

**Scenario 2: Bao Generate → GoPKI Use**
```go
// Generate with Bao
keyClient, _ := client.GenerateRSAKey(ctx, &bao.GenerateKeyOptions{
    KeyName: "my-key",
    KeyBits: 2048,
})

// Use with GoPKI
keyPair, _ := keyClient.KeyPair()
csr, _ := cert.CreateCSR(keyPair, csrReq)
```

**Scenario 3: Bao Issue Certificate with GoPKI Key**
```go
// GoPKI key
keyPair, _ := algo.GenerateRSAKeyPair(2048)

// Bao issues certificate
certClient, _ := client.IssueRSACertificate(ctx, "role", keyPair, opts)
certificate, _ := certClient.Certificate()
```

---

### 2. Certificate Compatibility (`cert_test.go`)

#### Purpose
Ensure certificate operations work across GoPKI and OpenBao.

#### Test Categories

**CSR Workflow**
- GoPKI creates CSR → OpenBao signs
- Subject info preservation
- SAN preservation
- Extension preservation

**CA Operations**
- Root CA creation and validation
- Intermediate CA chains
- OpenBao CA → GoPKI signing

**Certificate Validation**
- Parsing OpenBao certificates with GoPKI
- Verification with GoPKI cert module
- Chain validation

**Certificate Issuance Workflows**
- **Workflow 1**: OpenBao generates everything (key + cert)
- **Workflow 2**: Local key + OpenBao signs (CSR workflow)
- **Workflow 3**: OpenBao-managed key (internal, not exported)
- **Workflow 4**: Sign externally-created CSR

#### Certificate Chain Example

```
Root CA (OpenBao)
    ↓ signs
Intermediate CA (OpenBao)
    ↓ signs
End-Entity Cert (OpenBao issues, GoPKI key)
    ↓ validates with
GoPKI cert.VerifyCertificate()
```

---

### 3. Signing Compatibility (`signing_test.go`)

#### Purpose
Verify OpenBao-issued certificates work with GoPKI signing module.

#### Test Scenarios

**PKCS#7 Signing**
- RSA certificates from OpenBao → GoPKI PKCS#7 sign/verify
- ECDSA certificates → PKCS#7 operations
- Ed25519 certificates (with known limitations)

**Detached Signatures**
- Create detached signature
- Verify with correct data
- Reject with incorrect data

**Certificate Chains in PKCS#7**
- Include intermediate CA
- Include root CA
- Verify full chain

#### Example Flow

```go
// 1. Get certificate from OpenBao
certClient, _ := client.IssueRSACertificate(ctx, "code-signing", keyPair, opts)
certificate, _ := certClient.Certificate()

// 2. Sign with GoPKI
signature, _ := signing.Sign(data, keyPair, certificate, signing.SignatureOptions{
    Detached: false,
})

// 3. Verify with GoPKI
content, _ := signing.Verify(signature, signing.VerifyOptions{})
```

---

### 4. Encryption Compatibility (`encryption_test.go`)

#### Purpose
Test encryption operations with OpenBao materials.

#### Test Coverage

**RSA-OAEP Encryption**
- OpenBao key → GoPKI encrypt/decrypt
- GoPKI key + OpenBao certificate

**ECDH Key Agreement**
- Two OpenBao keys
- Mixed: GoPKI key + OpenBao key
- Shared secret derivation

**Certificate-Based Encryption**
- Encrypt for OpenBao certificate
- Decrypt with key

---

### 5. PKCS#12 Compatibility (`pkcs12_test.go`)

#### Purpose
Verify PKCS#12 bundle operations with OpenBao materials.

#### Test Scenarios

**Bundle Creation**
- OpenBao cert + key → PKCS#12
- Include CA chain
- Password protection

**Bundle Parsing**
- Parse bundle
- Extract key
- Re-import to OpenBao

**Integration**
- Full workflow: Issue → Export → Parse → Verify

---

### 6. JOSE Compatibility (`jose_test.go`)

#### Purpose
Test JOSE operations with OpenBao keys.

#### Test Coverage

**JWK Export/Import**
- OpenBao keys → JWK format
- JWK → Import to OpenBao

**JWS Signing**
- RS256 (RSA)
- ES256 (ECDSA)
- EdDSA (Ed25519)

**JWT Operations**
- Create and sign JWT
- Verify JWT
- Claims validation

---

### 7. End-to-End Workflows (`workflow_test.go`)

#### Purpose
Real-world integration scenarios combining multiple modules.

#### Workflow Examples

**Web Server Certificate**
```
1. Generate RSA key (GoPKI)
2. Create role in OpenBao
3. Issue certificate from OpenBao
4. Get CA certificate
5. Export to PKCS#12
6. Verify bundle
```

**Code Signing**
```
1. Generate ECDSA key (GoPKI)
2. Create code-signing role (OpenBao)
3. Issue certificate (OpenBao)
4. Sign code with PKCS#7 (GoPKI)
5. Verify signature (GoPKI)
```

**Mutual TLS**
```
1. Create server certificate (OpenBao)
2. Create client certificate (OpenBao)
3. Verify both chains (GoPKI)
4. Check extensions (ServerAuth, ClientAuth)
```

---

## Helper Functions

### Core Helpers (helpers.go)

#### `SetupBaoTest(t *testing.T) *TestEnvironment`
Creates a basic test environment with OpenBao running and PKI enabled.

**Returns:**
- `Container`: OpenBao testcontainer
- `Client`: Configured bao.Client
- `Ctx`: Context for operations
- `Cleanup`: Function to tear down

#### `SetupBaoWithCA(t *testing.T) (*TestEnvironment, *bao.IssuerClient)`
Sets up environment with a pre-created root CA.

**Returns:**
- TestEnvironment
- IssuerClient for the root CA

#### `SetupBaoWithCAAndRole(t, roleName, roleOpts) (*TestEnvironment, *bao.IssuerClient)`
Sets up environment with CA and a configured role.

### Utility Helpers

#### `CreateTestRootCA(ctx, client, issuerName, keyType, keyBits)`
Creates a test root CA with specified parameters.

#### `CreateTestIntermediateCA(ctx, client, parentIssuer, issuerName, keyType, keyBits)`
Creates an intermediate CA signed by parent.

#### `CreateStandardTestRole(ctx, issuer, roleName)`
Creates a role with common test settings.

### Validation Helpers

#### `ValidateCertificateChain(t, cert, caCert)`
Verifies certificate is signed by CA.

#### `AssertCertificateMatches(t, cert, expectedCN, expectedDNSNames)`
Validates certificate attributes.

---

## Common Patterns

### Pattern 1: Simple Test
```go
func testSomething(t *testing.T) {
    env := SetupBaoTest(t)
    defer env.Cleanup()

    // Test code here
}
```

### Pattern 2: Test with CA
```go
func testSomethingWithCA(t *testing.T) {
    env, issuer := SetupBaoWithCA(t)
    defer env.Cleanup()

    // Use issuer for operations
}
```

### Pattern 3: Test with Role
```go
func testSomethingWithRole(t *testing.T) {
    env, issuer := SetupBaoWithCAAndRole(t, "web-server", &bao.RoleOptions{
        AllowedDomains: []string{"example.com"},
        TTL: "720h",
        ServerFlag: true,
    })
    defer env.Cleanup()

    // Issue certificates using role
}
```

### Pattern 4: Parallel Tests
```go
func TestModule_Bao_Compatibility(t *testing.T) {
    t.Parallel() // Top-level can run in parallel

    t.Run("Feature1", func(t *testing.T) {
        t.Parallel() // Sub-tests run in parallel
        // Test code
    })
}
```

---

## Best Practices

### 1. Always Clean Up
```go
env := SetupBaoTest(t)
defer env.Cleanup() // Always defer cleanup
```

### 2. Use Descriptive Logging
```go
t.Log("=== Test Scenario ===")
t.Log("Step 1: Generate key")
t.Logf("✓ Success: Key type %s", keyInfo.KeyType)
```

### 3. Verify Both Directions
For each operation, test:
- GoPKI → OpenBao
- OpenBao → GoPKI

### 4. Test Error Cases
```go
// Should fail with wrong data
_, err := signing.VerifyDetached(signature, wrongData, opts)
if err == nil {
    t.Errorf("Should have failed")
}
```

### 5. Parallel Execution
Use `t.Parallel()` to speed up tests, but be aware each test gets its own OpenBao container.

### 6. Meaningful Assertions
```go
// Bad
if cert == nil {
    t.Error("cert is nil")
}

// Good
if cert.Subject.CommonName != "expected.com" {
    t.Errorf("Certificate CN mismatch: expected %q, got %q",
        "expected.com", cert.Subject.CommonName)
}
```

---

## Troubleshooting

### Test Failures

**Container won't start**
- Check Docker daemon is running
- Verify network connectivity
- Check Docker logs: `docker logs <container-id>`

**Timeout errors**
- Increase timeout: `go test -timeout 10m`
- Check system resources
- Verify OpenBao image is cached locally

**Certificate validation failures**
- Verify time synchronization
- Check certificate expiry
- Validate CA chain is correct

### Debugging Tips

**Enable verbose output**
```bash
go test -tags=compatibility ./compatibility/bao -v -run TestSpecific
```

**Run single test**
```bash
go test -tags=compatibility ./compatibility/bao -v -run TestKeypair/RSA_2048
```

**Check OpenBao logs**
```go
// In test, before cleanup:
logs, _ := env.Container.Logs(env.Ctx)
t.Logf("Container logs: %s", logs)
```

---

## Contributing

When adding new tests:

1. **Follow naming conventions** from this document
2. **Use existing helpers** from `helpers.go`
3. **Test bidirectionally** (both directions)
4. **Add descriptive comments** explaining what's being tested
5. **Update documentation** if adding new patterns
6. **Verify parallel execution** works correctly

---

## References

- [OpenBao API Documentation](https://openbao.org/api-docs/)
- [GoPKI Bao Package](../../bao/)
- [Testcontainers Go](https://golang.testcontainers.org/)
- [RFC 5280 - X.509](https://tools.ietf.org/html/rfc5280)
- [RFC 5652 - CMS](https://tools.ietf.org/html/rfc5652)
