# SSH (OpenSSH) Compatibility Testing Framework

This document provides comprehensive documentation for SSH key compatibility testing between GoPKI and OpenSSH tools, ensuring perfect interoperability for SSH key operations.

## Overview

The SSH compatibility framework validates that SSH keys, formats, fingerprints, and cryptographic operations generated by GoPKI are fully compatible with OpenSSH (`ssh-keygen`, `ssh-add`, `ssh-agent`) and vice versa. This ensures that GoPKI can be used as a drop-in replacement for SSH key operations in Go applications.

## Test Coverage

### Supported Algorithms

**RSA Keys**
- RSA-2048 (minimum secure size for SSH)
- RSA-3072 (enhanced security)
- RSA-4096 (maximum security)

**ECDSA Keys**
- P-256 (ecdsa-sha2-nistp256) - Most common curve
- P-384 (ecdsa-sha2-nistp384) - Enhanced security
- P-521 (ecdsa-sha2-nistp521) - Maximum security

**Ed25519 Keys**
- Ed25519 (ssh-ed25519) - Modern, high-performance curve

### Test Categories

#### 1. **Bidirectional Key Generation**
- GoPKI generates SSH keys â†’ ssh-keygen validates
- ssh-keygen generates keys â†’ GoPKI validates
- Full round-trip validation for all algorithms

#### 2. **Format Compatibility**
- OpenSSH private key format (RFC4716)
- OpenSSH public key format (authorized_keys)
- Passphrase-protected private keys
- Comment preservation in public keys

#### 3. **Fingerprint Validation**
- SHA256 fingerprint generation and comparison
- MD5 fingerprint generation (legacy support)
- Cross-tool fingerprint verification

#### 4. **Public Key Extraction**
- Extract public key from private key using ssh-keygen
- Verify extracted key matches original public key
- Fingerprint comparison for validation

#### 5. **Authorized Keys Format**
- Single-line format validation
- Key type prefix verification (ssh-rsa, ssh-ed25519, etc.)
- Comment handling and preservation

#### 6. **Passphrase Protection**
- AES128/AES256 encrypted private keys
- Bidirectional passphrase encryption/decryption
- Wrong passphrase error handling

### Edge Cases and Security

- Invalid SSH format detection
- Corrupted key handling
- Wrong passphrase scenarios
- Key permission validation
- Format boundary testing

## Running Tests

### Using Taskfile (Recommended)

```bash
# Run all compatibility tests including SSH
task test:compatibility

# Run SSH-specific tests only
go test -tags=compatibility ./compatibility/keypair -v -run TestSSH
```

### Direct Go Testing

```bash
# All SSH compatibility tests
go test -tags=compatibility ./compatibility/keypair -v -run "TestSSH.*"

# Specific SSH test categories
go test -tags=compatibility ./compatibility/keypair -v -run TestSSHKeypairCompatibility
go test -tags=compatibility ./compatibility/keypair -v -run TestSSHFingerprintCompatibility
go test -tags=compatibility ./compatibility/keypair -v -run TestSSHPublicKeyExtraction
go test -tags=compatibility ./compatibility/keypair -v -run TestSSHAuthorizedKeysFormat

# Specific algorithm tests
go test -tags=compatibility ./compatibility/keypair -v -run "TestSSHKeypairCompatibility/RSA"
go test -tags=compatibility ./compatibility/keypair -v -run "TestSSHKeypairCompatibility/ECDSA"
go test -tags=compatibility ./compatibility/keypair -v -run "TestSSHKeypairCompatibility/Ed25519"
```

## Test Output Interpretation

### Successful Test Output

```
ðŸ” Running SSH OpenSSH Compatibility Tests...
   Testing SSH key generation, validation, and format conversion

=== RUN   TestSSHKeypairCompatibility/RSA/RSA_2048/GoPKI_Generate_SSH_Validate
    â†’ Validating SSH private key with ssh-keygen...
    â†’ Executing: ssh-keygen -y -f /tmp/ssh_private_validate
    âœ“ SSH private key validation passed
    â†’ Validating SSH public key with ssh-keygen...
    â†’ Executing: ssh-keygen -l -f /tmp/ssh_public_validate.pub
    âœ“ SSH public key validation passed: 2048 SHA256:xxxxx test@gopki.com (RSA)
    âœ“ GoPKI RSA-2048 SSH keys validated by ssh-keygen

--- PASS: TestSSHKeypairCompatibility/RSA/RSA_2048 (0.45s)
```

### Failed Test Indicators

- `âŒ SSH private key validation failed:` - ssh-keygen rejected the private key
- `âŒ SSH public key validation failed:` - ssh-keygen rejected the public key
- `Should fail to load encrypted key without passphrase` - Expected failure for security
- Test failure with specific error description

## SSH Commands Used

The framework uses the following ssh-keygen commands for validation:

### Key Generation
```bash
# RSA key generation
ssh-keygen -t rsa -b 2048 -f ssh_private -N "" -q

# ECDSA key generation
ssh-keygen -t ecdsa -b 256 -f ssh_private -N "" -q

# Ed25519 key generation
ssh-keygen -t ed25519 -f ssh_private -N "" -q

# With passphrase
ssh-keygen -t rsa -b 2048 -f ssh_private -N "passphrase" -q
```

### Key Validation
```bash
# Validate private key and extract public key
ssh-keygen -y -f private_key

# Get fingerprint and validate public key
ssh-keygen -l -f public_key.pub

# Get SHA256 fingerprint
ssh-keygen -l -E sha256 -f public_key.pub

# Get MD5 fingerprint (legacy)
ssh-keygen -l -E md5 -f public_key.pub
```

### Format Conversion
```bash
# Convert between formats (PEM to SSH)
ssh-keygen -p -m RFC4716 -f key_file -N "" -P ""

# Extract public key from private key
ssh-keygen -y -f private_key > public_key.pub
```

## Framework Architecture

### SSH Helper Functions (helpers.go)

**Key Generation**
- `GenerateSSHKeyWithSSHKeygen()` - Generate keys using ssh-keygen
- `GenerateSSHKeyWithPassphrase()` - Generate passphrase-protected keys

**Validation Functions**
- `ValidateSSHPrivateKeyWithSSHKeygen()` - Validate private key format
- `ValidateSSHPublicKeyWithSSHKeygen()` - Validate public key format
- `ValidateAuthorizedKeysFormat()` - Check authorized_keys compatibility

**Utility Functions**
- `GetSSHKeyFingerprint()` - Get SHA256/MD5 fingerprints
- `ExtractPublicKeyWithSSHKeygen()` - Extract public from private key
- `ConvertPEMToSSHWithSSHKeygen()` - Format conversion

### Test Structure (ssh_test.go)

Each test follows the pattern:
1. **Setup** - Create OpenSSL helper and temporary directories
2. **Generate** - Create SSH keys using either GoPKI or ssh-keygen
3. **Convert** - Transform keys between formats if needed
4. **Validate** - Verify compatibility using the other tool
5. **Compare** - Ensure fingerprints and key properties match
6. **Cleanup** - Remove temporary files

### Key Test Functions

**TestSSHKeypairCompatibility**
- Tests all algorithms (RSA, ECDSA, Ed25519)
- Bidirectional key generation and validation
- Passphrase protection for all algorithms

**TestSSHFingerprintCompatibility**
- SHA256 fingerprint generation
- MD5 fingerprint generation
- Cross-tool fingerprint comparison

**TestSSHPublicKeyExtraction**
- Extract public key from private key
- Verify extraction accuracy
- Fingerprint validation

**TestSSHAuthorizedKeysFormat**
- Validate single-line format
- Check key type prefixes
- Comment preservation

## Dependencies

### Required Software
- OpenSSH 8.0+ (compatible with older versions)
- Go 1.21+ with module support
- testify assertion library

### Go Dependencies
```go
import (
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"
    "github.com/jasoet/gopki/keypair"
    "github.com/jasoet/gopki/keypair/algo"
    "github.com/jasoet/gopki/keypair/format"
)
```

### OpenSSH Version Compatibility

The tests are designed to work with:
- **OpenSSH 8.x-10.x** (primary target)
- **OpenSSH 7.x** (legacy support)
- **Portable OpenSSH** (cross-platform)

Version-specific behavior is handled automatically by the framework.

## Security Considerations

### Validation Scope

The compatibility tests verify:
- **Format Correctness** - Keys follow OpenSSH format specifications
- **Cryptographic Validity** - Keys are mathematically correct
- **Passphrase Protection** - Encryption/decryption works correctly
- **Fingerprint Accuracy** - Fingerprints match across implementations
- **authorized_keys Compatibility** - Keys work in SSH authorized_keys files

### Security Boundaries

The tests do NOT validate:
- SSH protocol implementation
- Network security aspects
- SSH agent forwarding security
- Key exchange protocols

### Key Material Handling

- All test keys are generated in temporary directories with 0600 permissions
- Private keys are automatically cleaned up after tests
- Passphrase-protected keys use strong encryption
- No real cryptographic material is exposed
- Test keys should never be used in production

## Troubleshooting

### Common Issues

**ssh-keygen Not Found**
```bash
# Check if ssh-keygen is in PATH
which ssh-keygen

# Check SSH version
ssh -V

# Install OpenSSH on macOS
brew install openssh

# Install OpenSSH on Ubuntu/Debian
sudo apt-get install openssh-client

# Install OpenSSH on RHEL/CentOS
sudo yum install openssh-clients
```

**Permission Errors**
```bash
# Ensure temporary directory is writable
chmod 755 /tmp

# Check file permissions
ls -la ~/.ssh/

# Fix SSH key permissions
chmod 600 ~/.ssh/id_*
chmod 644 ~/.ssh/id_*.pub
```

**Passphrase Issues**
- Ensure passphrase is correctly quoted in tests
- Check for special characters that need escaping
- Verify encryption algorithm support

**Format Conversion Failures**
- Check OpenSSH version for RFC4716 support
- Verify key format is valid before conversion
- Check for trailing newlines or whitespace

### Debugging Tests

Enable verbose logging:
```bash
# Maximum verbosity
go test -tags=compatibility ./compatibility/keypair -v -run TestSSH

# With detailed output
go test -tags=compatibility ./compatibility/keypair -v -run TestSSH -count=1

# Debug specific algorithm
SSH_DEBUG=1 go test -tags=compatibility ./compatibility/keypair -v -run "TestSSH.*RSA"
```

### Performance Considerations

- RSA-4096 key generation can take 1-2 seconds
- Ed25519 offers best performance/security ratio
- ECDSA tests are typically faster than RSA
- Passphrase encryption adds ~100ms overhead
- Parallel test execution is automatically handled

## Integration Examples

### CI/CD Integration

```yaml
# GitHub Actions example
- name: Run SSH Compatibility Tests
  run: |
    task test:compatibility

# Jenkins example
pipeline {
    stages {
        stage('SSH Compatibility Tests') {
            steps {
                sh 'go test -tags=compatibility ./compatibility/keypair -v -run TestSSH'
            }
        }
    }
}
```

### Docker Integration

```dockerfile
FROM golang:1.21-alpine
RUN apk add --no-cache openssh-client
COPY . /app
WORKDIR /app
RUN go test -tags=compatibility ./compatibility/keypair -v -run TestSSH
```

### Using Generated Keys

```go
// Generate SSH keys with GoPKI
manager, _ := keypair.Generate[algo.KeySize, *algo.RSAKeyPair, *rsa.PrivateKey, *rsa.PublicKey](algo.KeySize2048)
privateSSH, publicSSH, _ := manager.ToSSH("user@example.com", "passphrase")

// Save to files for SSH use
os.WriteFile("~/.ssh/id_rsa", []byte(privateSSH), 0600)
os.WriteFile("~/.ssh/id_rsa.pub", []byte(publicSSH), 0644)

// Add public key to authorized_keys
authorizedKeys, _ := os.ReadFile("~/.ssh/authorized_keys")
authorizedKeys = append(authorizedKeys, []byte(publicSSH)...)
os.WriteFile("~/.ssh/authorized_keys", authorizedKeys, 0600)
```

## Contributing

### Adding New SSH Tests

1. Add test functions following the existing pattern in `ssh_test.go`
2. Use the provided SSH helper functions from `helpers.go`
3. Include bidirectional testing (GoPKI â†” ssh-keygen)
4. Add fingerprint validation for new test cases
5. Update this documentation with new test coverage

### Test Enhancement Guidelines

- Always use testify assertions (`assert` and `require`)
- Include descriptive test names and logging
- Test both success and failure cases
- Validate edge cases and boundary conditions
- Ensure test independence (no shared state)
- Clean up all temporary resources

### Code Quality Standards

- Follow Go best practices and idioms
- Add comprehensive error handling
- Use meaningful variable names
- Include comments for complex logic
- Maintain consistent formatting

## References

### OpenSSH Documentation

- [ssh-keygen Manual](https://man.openbsd.org/ssh-keygen)
- [SSH Public Key Format](https://tools.ietf.org/html/rfc4253#section-6.6)
- [OpenSSH Private Key Format](https://github.com/openssh/openssh-portable/blob/master/PROTOCOL.key)
- [authorized_keys Format](https://man.openbsd.org/sshd#AUTHORIZED_KEYS_FILE_FORMAT)

### Standards Compliance

- **RFC 4253** - SSH Transport Layer Protocol (public key format)
- **RFC 4716** - SSH Public Key File Format
- **RFC 8332** - Use of RSA Keys with SHA-256 and SHA-512
- **RFC 8709** - Ed25519 and Ed448 for SSH

### GoPKI Integration

- [Keypair Module Documentation](../../keypair/README.md)
- [SSH Format Implementation](../../keypair/format/)
- [Algorithm-Specific SSH Support](../../keypair/algo/)

This framework ensures GoPKI maintains **100% compatibility** with OpenSSH operations across all supported algorithms and key formats.