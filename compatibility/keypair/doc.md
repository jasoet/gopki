# OpenSSL Compatibility Testing Framework

This directory contains comprehensive compatibility tests between GoPKI and OpenSSL, ensuring perfect interoperability between the two cryptographic implementations.

## Overview

The OpenSSL compatibility framework validates that keys, signatures, and cryptographic operations generated by GoPKI are fully compatible with OpenSSL and vice versa. This ensures that GoPKI can be used as a drop-in replacement for OpenSSL operations in Go applications.

## Test Coverage

### Supported Algorithms

**RSA Keys**
- RSA-2048 (minimum secure size)
- RSA-3072 (enhanced security)
- RSA-4096 (maximum security)

**ECDSA Keys**
- P-256 (prime256v1) - Most common curve
- P-384 (secp384r1) - Enhanced security
- P-521 (secp521r1) - Maximum security

**Ed25519 Keys**
- Ed25519 (modern curve) - High performance, excellent security

### Test Categories

1. **Bidirectional Key Generation**
   - GoPKI generates ‚Üí OpenSSL validates
   - OpenSSL generates ‚Üí GoPKI validates

2. **Format Compatibility**
   - PEM format verification
   - DER format verification
   - SSH format compatibility

3. **Cryptographic Operations**
   - Digital signature generation and verification
   - Cross-platform signature validation
   - Key component mathematical verification

4. **Edge Cases and Security**
   - Invalid key size handling
   - Corrupted data detection
   - Type safety validation

## Directory Structure

```
compatibility/
‚îú‚îÄ‚îÄ keypair/            # Keypair-specific compatibility tests
‚îÇ   ‚îú‚îÄ‚îÄ keypair_test.go # Main keypair compatibility test suite
‚îÇ   ‚îî‚îÄ‚îÄ doc.md         # This documentation
‚îú‚îÄ‚îÄ helpers.go          # OpenSSL integration utilities
‚îî‚îÄ‚îÄ testdata/           # Test data directory
    ‚îú‚îÄ‚îÄ generated/      # Files generated during tests
    ‚îî‚îÄ‚îÄ reference/      # Reference files for validation
```

## Running Tests

### Using Taskfile (Recommended)

```bash
# Run all compatibility tests
task test:compatibility

# Show available tasks
task help:quality
```

### Direct Go Testing

```bash
# All compatibility tests
go test -mod=mod ./compatibility/... -v

# Keypair-specific tests
go test -mod=mod ./compatibility/keypair -v

# Specific algorithm tests
go test -mod=mod ./compatibility/keypair -v -run TestRSAKeypairCompatibility
go test -mod=mod ./compatibility/keypair -v -run TestECDSAKeypairCompatibility
go test -mod=mod ./compatibility/keypair -v -run TestEd25519KeypairCompatibility

# Specific test case
go test -mod=mod ./compatibility/keypair -v -run TestRSAKeypairCompatibility/RSA_2048
```

## Test Output Interpretation

### Successful Test Output

```
üîê Running RSA OpenSSL Compatibility Tests...
   Testing RSA 2048/3072/4096 compatibility

=== RUN   TestRSAKeypairCompatibility/RSA_2048/GoPKI_Generate_OpenSSL_Validate
    ‚Üí Validating RSA private key with OpenSSL...
    ‚Üí Executing: openssl rsa -in /tmp/private_key.pem -check -noout
    ‚úì Success: RSA key ok
    ‚úì RSA private key validation passed
    ‚úì GoPKI RSA-2048 key validated by OpenSSL

--- PASS: TestRSAKeypairCompatibility/RSA_2048 (0.21s)
```

### Failed Test Indicators

- `‚ùå Command failed:` - OpenSSL command execution failed
- `‚ùå Output:` - Detailed error message from OpenSSL
- Test failure with specific error description

## OpenSSL Commands Used

The framework executes the following OpenSSL commands for validation:

### Key Generation
```bash
# RSA key generation
openssl genpkey -algorithm RSA -out private.pem -pkeyopt rsa_keygen_bits:2048

# ECDSA key generation
openssl genpkey -algorithm EC -out private.pem -pkeyopt ec_paramgen_curve:prime256v1

# Ed25519 key generation
openssl genpkey -algorithm Ed25519 -out private.pem

# Public key extraction
openssl pkey -in private.pem -pubout -out public.pem
```

### Key Validation
```bash
# RSA key validation
openssl rsa -in private.pem -check -noout

# ECDSA key validation
openssl ec -in private.pem -check -noout

# Ed25519 key validation
openssl pkey -in private.pem -check -noout

# Public key validation
openssl pkey -pubin -in public.pem -noout
```

### Signature Operations
```bash
# Generate signature
openssl dgst -sha256 -sign private.pem -out signature.bin data.txt

# Verify signature
openssl dgst -sha256 -verify public.pem -signature signature.bin data.txt

# Ed25519 signature (different command)
openssl pkeyutl -sign -inkey private.pem -in data.txt -out signature.bin
openssl pkeyutl -verify -pubin -inkey public.pem -in data.txt -sigfile signature.bin
```

## Framework Architecture

### Helper Functions

**OpenSSLHelper**
- Manages temporary files and directories
- Executes OpenSSL commands with detailed logging
- Provides algorithm-specific key generation
- Handles signature operations

**Key Parsing Functions**
- `ParsePrivateKeyPEM()` - Parse PEM-encoded private keys
- `ParsePublicKeyPEM()` - Parse PEM-encoded public keys
- Type-safe key validation

**Comparison Functions**
- `CompareRSAKeys()` - Mathematical comparison of RSA keys
- `CompareECDSAKeys()` - ECDSA key component verification
- `CompareEd25519Keys()` - Ed25519 key byte comparison

### Test Structure

Each test follows the pattern:
1. **Setup** - Create OpenSSL helper and temporary directories
2. **Generate** - Create keys using either GoPKI or OpenSSL
3. **Convert** - Transform keys to required formats
4. **Validate** - Verify compatibility using the other tool
5. **Compare** - Ensure mathematical equivalence
6. **Cleanup** - Remove temporary files

### Error Handling

The framework uses testify assertions for clean error handling:
- `require.NoError()` - Fatal errors that stop test execution
- `assert.NoError()` - Non-fatal errors that continue testing
- `assert.Equal()` - Value comparison with detailed output
- `assert.True()` - Boolean condition validation

## Dependencies

### Required Software
- OpenSSL 3.0+ (compatible with older versions)
- Go 1.21+ with module support
- testify assertion library

### Go Dependencies
```go
import (
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"
    "github.com/jasoet/gopki/keypair"
    "github.com/jasoet/gopki/keypair/algo"
)
```

### OpenSSL Version Compatibility

The tests are designed to work with:
- **OpenSSL 3.x** (primary target)
- **OpenSSL 1.1.1** (legacy support)
- **LibreSSL** (partial compatibility)

Version-specific behavior is handled automatically by the framework.

## Security Considerations

### Validation Scope

The compatibility tests verify:
- **Cryptographic Correctness** - Keys generate valid cryptographic operations
- **Format Standards Compliance** - Output matches RFC specifications
- **Cross-Platform Interoperability** - Works across different systems
- **Algorithm Parameter Validation** - Correct curve parameters, key sizes

### Security Boundaries

The tests do NOT validate:
- Side-channel attack resistance
- Timing attack protection
- Hardware security module integration
- Key entropy quality (beyond basic validation)

### Key Material Handling

- All test keys are generated in temporary directories
- Private keys are automatically cleaned up after tests
- No real cryptographic material is exposed
- Test keys should never be used in production

## Troubleshooting

### Common Issues

**OpenSSL Not Found**
```bash
# Install OpenSSL on macOS
brew install openssl

# Install OpenSSL on Ubuntu/Debian
sudo apt-get install openssl

# Install OpenSSL on RHEL/CentOS
sudo yum install openssl
```

**Permission Errors**
```bash
# Ensure temporary directory is writable
chmod 755 /tmp

# Check Go module permissions
go clean -modcache
```

**Version Conflicts**
```bash
# Check OpenSSL version
openssl version

# Use specific version (if needed)
/usr/local/opt/openssl@3/bin/openssl version
```

### Debugging Tests

Enable verbose logging:
```bash
# Maximum verbosity
go test -mod=mod ./compatibility -v -run TestName

# Add custom debug logging
OPENSSL_COMPAT_DEBUG=1 go test -mod=mod ./compatibility -v
```

### Performance Considerations

- RSA-4096 key generation can take 1-2 seconds
- ECDSA tests are typically fastest
- Ed25519 offers best performance/security ratio
- Parallel test execution is automatically handled

## Integration Examples

### CI/CD Integration

```yaml
# GitHub Actions example
- name: Run OpenSSL Compatibility Tests
  run: |
    task test:compatibility

# Jenkins example
pipeline {
    stages {
        stage('Compatibility Tests') {
            steps {
                sh 'task test:compatibility'
            }
        }
    }
}
```

### Docker Integration

```dockerfile
FROM golang:1.21-alpine
RUN apk add --no-cache openssl
COPY . /app
WORKDIR /app
RUN go test -mod=mod ./compatibility -v
```

## Contributing

### Adding New Algorithm Tests

1. Create algorithm-specific helper functions in `helpers.go`
2. Add test cases following the existing pattern
3. Update Taskfile with new test targets
4. Add documentation for the new algorithm

### Test Enhancement Guidelines

- Always use bidirectional testing (GoPKI ‚Üî OpenSSL)
- Include format conversion verification
- Add signature interoperability tests
- Validate edge cases and error conditions
- Use descriptive test names and logging

### Code Quality Standards

- Use testify assertions for clean error handling
- Add comprehensive logging for debugging
- Follow existing naming conventions
- Ensure test independence (no shared state)
- Clean up temporary resources

## References

### Standards Compliance

- **RFC 3447** - RSA PKCS #1 v2.1
- **RFC 5480** - Elliptic Curve Cryptography Subject Public Key Info
- **RFC 8032** - Edwards-Curve Digital Signature Algorithm (EdDSA)
- **RFC 5652** - Cryptographic Message Syntax (CMS)

### OpenSSL Documentation

- [OpenSSL Command Line Tools](https://www.openssl.org/docs/man3.0/man1/)
- [OpenSSL Key Generation](https://www.openssl.org/docs/man3.0/man1/openssl-genpkey.html)
- [OpenSSL Digital Signatures](https://www.openssl.org/docs/man3.0/man1/openssl-dgst.html)

### GoPKI Integration

- [Keypair Module Documentation](../keypair/README.md)
- [Algorithm-Specific Implementation](../keypair/algo/)
- [Format Conversion Guide](../keypair/format/)