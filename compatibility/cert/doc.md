# OpenSSL Certificate Compatibility Testing Framework

This directory contains comprehensive compatibility tests between GoPKI and OpenSSL for certificate operations, ensuring perfect interoperability between the two cryptographic implementations for X.509 certificate management.

## Overview

The OpenSSL certificate compatibility framework validates that certificates, certificate chains, and cryptographic operations generated by GoPKI are fully compatible with OpenSSL and vice versa. This ensures that GoPKI can be used as a drop-in replacement for OpenSSL certificate operations in Go applications.

## Test Coverage

### Supported Algorithms

**RSA Certificates**
- RSA-2048 (minimum secure size for certificates)
- RSA-4096 (maximum security for CA certificates)

**ECDSA Certificates**
- P-256 (prime256v1) - Most common curve for certificates
- P-384 (secp384r1) - Enhanced security for CA certificates

**Ed25519 Certificates**
- Ed25519 (modern curve) - High performance, excellent security

### Test Categories

1. **Self-Signed Certificate Compatibility**
   - GoPKI generates ‚Üí OpenSSL validates
   - OpenSSL generates ‚Üí GoPKI validates
   - Format conversion and validation

2. **CA Certificate Compatibility**
   - CA certificate generation and validation
   - Path length constraint verification
   - CA extension validation (BasicConstraints, KeyUsage)

3. **Certificate Signing Compatibility**
   - CA signs certificates using both tools
   - Cross-validation of signed certificates
   - Certificate chain verification

4. **Certificate Chain Validation**
   - Multi-level certificate chains (Root ‚Üí Intermediate ‚Üí End Entity)
   - Cross-tool chain validation
   - Path length constraint enforcement

5. **Format Interoperability**
   - PEM ‚Üî DER format conversion
   - Certificate content preservation
   - Cross-parsing validation

6. **Subject Alternative Names (SAN)**
   - DNS names, IP addresses, email addresses
   - Multi-SAN certificate validation
   - Wildcard certificate support

7. **Advanced Certificate Features**
   - Certificate extension validation
   - Key usage and extended key usage verification
   - Certificate validity period handling

8. **Edge Cases and Error Handling**
   - Invalid certificate handling
   - Expired certificate detection
   - Malformed certificate rejection

## Directory Structure

```
compatibility/cert/
‚îú‚îÄ‚îÄ cert_test.go           # Main certificate compatibility test suite
‚îú‚îÄ‚îÄ doc.md                 # This documentation
‚îî‚îÄ‚îÄ testdata/              # Test data directory
    ‚îú‚îÄ‚îÄ generated/         # Files generated during tests
    ‚îî‚îÄ‚îÄ reference/         # Reference files for validation
```

## Running Tests

### Using Taskfile (Recommended)

```bash
# Run all compatibility tests (includes certificate tests)
task test:compatibility

# Show available tasks
task help:quality
```

### Direct Go Testing

```bash
# All compatibility tests
go test -tags=compatibility ./compatibility/... -v

# Certificate-specific tests only
go test -tags=compatibility ./compatibility/cert -v

# Specific test categories
go test -tags=compatibility ./compatibility/cert -v -run TestSelfSignedCertificateCompatibility
go test -tags=compatibility ./compatibility/cert -v -run TestCACertificateCompatibility
go test -tags=compatibility ./compatibility/cert -v -run TestCertificateSigningCompatibility
go test -tags=compatibility ./compatibility/cert -v -run TestCertificateChainValidation

# Specific algorithm tests
go test -tags=compatibility ./compatibility/cert -v -run TestSelfSignedCertificateCompatibility/RSA_2048
go test -tags=compatibility ./compatibility/cert -v -run TestSelfSignedCertificateCompatibility/ECDSA_P256
go test -tags=compatibility ./compatibility/cert -v -run TestSelfSignedCertificateCompatibility/Ed25519
```

## Test Output Interpretation

### Successful Test Output

```
üîê Running Self-Signed Certificate OpenSSL Compatibility Tests...
   Testing self-signed certificate generation and validation

=== RUN   TestSelfSignedCertificateCompatibility/RSA_2048/GoPKI_Generate_OpenSSL_Validate
    ‚Üí Validating certificate with OpenSSL...
    ‚Üí Executing: openssl x509 -in /tmp/validate_cert.pem -text -noout
    ‚úì Success: Certificate:
        Data:
            Version: 3 (0x2)
            Serial Number:
                12:34:56:78:9a:bc:de:f0
    ‚úì Certificate validation passed
    ‚úì GoPKI RSA-2048 self-signed certificate validated by OpenSSL

--- PASS: TestSelfSignedCertificateCompatibility/RSA_2048 (0.31s)
```

### Failed Test Indicators

- `‚ùå Command failed:` - OpenSSL command execution failed
- `‚ùå Output:` - Detailed error message from OpenSSL
- Test failure with specific error description

## OpenSSL Commands Used

The framework executes the following OpenSSL commands for validation:

### Certificate Generation

```bash
# Self-signed certificate generation
openssl req -new -x509 -key private.pem -out cert.pem -days 365 -config cert.conf -batch

# CA certificate generation
openssl req -new -x509 -key ca_private.pem -out ca_cert.pem -days 3650 -config ca.conf -batch -extensions v3_ca

# Certificate signing request
openssl req -new -key private.pem -out cert.csr -config csr.conf -batch

# Certificate signing
openssl x509 -req -in cert.csr -CA ca_cert.pem -CAkey ca_private.pem -CAcreateserial -out cert.pem -days 365 -extensions v3_req -extfile signing.conf
```

### Certificate Validation

```bash
# Certificate validation
openssl x509 -in cert.pem -text -noout

# Certificate chain verification
openssl verify -CAfile ca_cert.pem cert.pem

# Multi-level chain verification
openssl verify -CAfile root_ca.pem -untrusted intermediate_ca.pem cert.pem
```

### Format Conversion

```bash
# PEM to DER conversion
openssl x509 -in cert.pem -outform DER -out cert.der

# DER to PEM conversion
openssl x509 -in cert.der -inform DER -outform PEM -out cert.pem
```

## Framework Architecture

### Helper Functions

**OpenSSLHelper Extensions for Certificates**
- `GenerateSelfSignedCertWithOpenSSL()` - Self-signed certificate generation
- `GenerateCACertWithOpenSSL()` - CA certificate generation
- `SignCertificateWithOpenSSL()` - Certificate signing operations
- `GenerateCSRWithOpenSSL()` - Certificate signing request generation
- `ValidateCertificateWithOpenSSL()` - Certificate validation
- `VerifyCertificateChainWithOpenSSL()` - Chain verification
- `ConvertCertPEMToDERWithOpenSSL()` - Format conversion utilities
- `ConvertCertDERToPEMWithOpenSSL()` - Format conversion utilities

**Configuration File Generation**
- `createOpenSSLConfig()` - Self-signed certificate configuration
- `createCAConfig()` - CA certificate configuration
- `createCSRConfig()` - CSR generation configuration
- `createSigningConfig()` - Certificate signing configuration

**Certificate Parsing Functions**
- Uses GoPKI `cert.ParseCertificateFromPEM()` for validation
- Uses GoPKI `cert.VerifyCertificate()` for chain validation
- Cross-validation with OpenSSL commands

### Test Structure

Each test follows the pattern:
1. **Setup** - Create OpenSSL helper and generate test key pairs
2. **Generate** - Create certificates using either GoPKI or OpenSSL
3. **Cross-Validate** - Verify compatibility using the other tool
4. **Format Test** - Ensure format conversion compatibility
5. **Chain Test** - Verify certificate chain operations
6. **Cleanup** - Remove temporary files

### Error Handling

The framework uses testify assertions for clean error handling:
- `require.NoError()` - Fatal errors that stop test execution
- `assert.NoError()` - Non-fatal errors that continue testing
- `assert.Equal()` - Value comparison with detailed output
- `assert.True()` - Boolean condition validation

## Configuration Files

The framework generates OpenSSL configuration files for consistent certificate generation:

### Self-Signed Certificate Configuration

```ini
[req]
distinguished_name = req_distinguished_name
req_extensions = v3_req
prompt = no

[req_distinguished_name]
CN=Test Certificate,O=GoPKI,C=US

[v3_req]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
subjectAltName = DNS:localhost,DNS:example.com,IP:127.0.0.1
```

### CA Certificate Configuration

```ini
[req]
distinguished_name = req_distinguished_name
x509_extensions = v3_ca
prompt = no

[req_distinguished_name]
CN=Test CA,O=GoPKI,C=US

[v3_ca]
basicConstraints = critical,CA:true
keyUsage = critical, digitalSignature, cRLSign, keyCertSign
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer
```

## Dependencies

### Required Software
- OpenSSL 3.0+ (compatible with older versions)
- Go 1.21+ with module support
- testify assertion library

### Go Dependencies
```go
import (
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"
    "github.com/jasoet/gopki/cert"
    "github.com/jasoet/gopki/keypair"
    "github.com/jasoet/gopki/keypair/algo"
    "github.com/jasoet/gopki/compatibility"
)
```

### OpenSSL Version Compatibility

The tests are designed to work with:
- **OpenSSL 3.x** (primary target)
- **OpenSSL 1.1.1** (legacy support)
- **LibreSSL** (partial compatibility)

Version-specific behavior is handled automatically by the framework.

## Security Considerations

### Validation Scope

The compatibility tests verify:
- **Certificate Generation Correctness** - Certificates follow X.509 standards
- **Format Standards Compliance** - Output matches RFC 5280 specifications
- **Cross-Platform Interoperability** - Works across different systems
- **Extension Handling** - Proper certificate extension support
- **Chain Validation** - Certificate chain verification works correctly

### Security Boundaries

The tests do NOT validate:
- Certificate revocation mechanisms (CRL/OCSP)
- Hardware security module integration
- Certificate transparency log operations
- Advanced certificate policies

### Certificate Material Handling

- All test certificates are generated in temporary directories
- Private keys are automatically cleaned up after tests
- No real cryptographic material is exposed
- Test certificates should never be used in production

## Troubleshooting

### Common Issues

**OpenSSL Not Found**
```bash
# Install OpenSSL on macOS
brew install openssl

# Install OpenSSL on Ubuntu/Debian
sudo apt-get install openssl

# Install OpenSSL on RHEL/CentOS
sudo yum install openssl
```

**Permission Errors**
```bash
# Ensure temporary directory is writable
chmod 755 /tmp

# Check Go module permissions
go clean -modcache
```

**Version Conflicts**
```bash
# Check OpenSSL version
openssl version

# Use specific version (if needed)
/usr/local/opt/openssl@3/bin/openssl version
```

### Debugging Tests

Enable verbose logging:
```bash
# Maximum verbosity
go test -tags=compatibility ./compatibility/cert -v -run TestName

# Add custom debug logging
OPENSSL_COMPAT_DEBUG=1 go test -tags=compatibility ./compatibility/cert -v
```

### Performance Considerations

- RSA-4096 certificate generation can take 1-2 seconds
- ECDSA certificate tests are typically fastest
- Ed25519 offers best performance/security ratio for certificates
- Certificate chain validation is CPU-intensive
- Parallel test execution is automatically handled

## Integration Examples

### CI/CD Integration

```yaml
# GitHub Actions example
- name: Run Certificate Compatibility Tests
  run: |
    task test:compatibility

# Jenkins example
pipeline {
    stages {
        stage('Certificate Compatibility Tests') {
            steps {
                sh 'go test -tags=compatibility ./compatibility/cert -v'
            }
        }
    }
}
```

### Docker Integration

```dockerfile
FROM golang:1.21-alpine
RUN apk add --no-cache openssl
COPY . /app
WORKDIR /app
RUN go test -tags=compatibility ./compatibility/cert -v
```

## Contributing

### Adding New Certificate Tests

1. Add new test functions following the existing pattern
2. Use the provided OpenSSL helper functions
3. Include both GoPKI ‚Üí OpenSSL and OpenSSL ‚Üí GoPKI validation
4. Add format conversion verification
5. Update documentation for new test categories

### Test Enhancement Guidelines

- Always use bidirectional testing (GoPKI ‚Üî OpenSSL)
- Include certificate chain verification
- Add Subject Alternative Name validation
- Validate certificate extensions and constraints
- Use descriptive test names and logging
- Test edge cases and error conditions

### Code Quality Standards

- Use testify assertions for clean error handling
- Add comprehensive logging for debugging
- Follow existing naming conventions
- Ensure test independence (no shared state)
- Clean up temporary resources
- Use build tags for conditional testing

## References

### Standards Compliance

- **RFC 5280** - Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL) Profile
- **RFC 3647** - Internet X.509 Public Key Infrastructure Certificate Policy and Certification Practices Framework
- **RFC 6818** - Updates to the Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL) Profile

### OpenSSL Documentation

- [OpenSSL Certificate Commands](https://www.openssl.org/docs/man3.0/man1/openssl-x509.html)
- [OpenSSL Certificate Generation](https://www.openssl.org/docs/man3.0/man1/openssl-req.html)
- [OpenSSL Certificate Verification](https://www.openssl.org/docs/man3.0/man1/openssl-verify.html)

### GoPKI Integration

- [Certificate Module Documentation](../cert/README.md)
- [Keypair Module Integration](../keypair/)
- [Certificate Examples](../examples/certificates/)

This framework ensures GoPKI maintains **100% compatibility** with OpenSSL certificate operations across all supported algorithms and certificate types.